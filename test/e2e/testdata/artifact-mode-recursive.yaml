apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: artifact-mode-permission-fail
  labels:
    argo-e2e: true
spec:
  entrypoint: artifact-example
  templates:
  - name: artifact-example
    steps:
    - - name: generate-artifact
        template: whalesay
    - - name: artifact-mode-recurse
        template: artifact-mode-read-recurse
        arguments:
          artifacts:
          - name: message
            from: "{{steps.generate-artifact.outputs.artifacts.hello-art}}"
      - name: artifact-mode-recurse-argument
        template: artifact-mode-read
        arguments:
          artifacts:
          - name: message
            from: "{{steps.generate-artifact.outputs.artifacts.hello-art}}"
            recurseMode: true
      - name: artifact-mode
        template: artifact-mode-read
        arguments:
          artifacts:
          - name: message
            from: "{{steps.generate-artifact.outputs.artifacts.hello-art}}"

  - name: whalesay
    container:
      image: argoproj/argosay:v1
      command: [sh, -c]
      args: ["sleep 1; mkdir /tmp/message && cowsay hello world | tee /tmp/message/hello_world.txt"]
    outputs:
      artifacts:
      - name: hello-art
        path: /tmp

  - name: artifact-mode-read-recurse
    inputs:
      artifacts:
      - name: message
        path: /tmp/hello-art
        mode: 0777
        recurseMode: true
    container:
      image: argoproj/argosay:v1
      imagePullPolicy: IfNotPresent
      command: [sh, -c]
      args: [
        "stat -c '%a' /tmp/hello-art/message > /tmp/folder-mode.txt && stat -c '%a' /tmp/hello-art/message/hello_world.txt > /tmp/file-mode.txt && sleep 1"
      ]
    outputs:
      parameters:
      - name: folder-mode
        valueFrom:
          path: /tmp/folder-mode.txt
      - name: file-mode
        valueFrom:
          path: /tmp/file-mode.txt

  - name: artifact-mode-read
    inputs:
      artifacts:
      - name: message
        path: /tmp/hello-art
        mode: 0777
    container:
      image: argoproj/argosay:v1
      imagePullPolicy: IfNotPresent
      command: [sh, -c]
      args: [
        "stat -c '%a' /tmp/hello-art/message > /tmp/folder-mode.txt && stat -c '%a' /tmp/hello-art/message/hello_world.txt > /tmp/file-mode.txt && sleep 1"
      ]
    outputs:
      parameters:
      - name: folder-mode
        valueFrom:
          path: /tmp/folder-mode.txt
      - name: file-mode
        valueFrom:
          path: /tmp/file-mode.txt